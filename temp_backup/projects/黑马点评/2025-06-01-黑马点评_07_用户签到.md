---
title: "黑马点评_07_用户签到"
date: 2025-06-01 07:07:07 +0800
categories: [JAVA后端项目, 黑马点评]
tags: [分布式, Redis]
pin: false
toc: true
math: true
---

## S (Situation - 情景):

需要记录每个用户每天的签到情况。如果用传统数据库表来存，每个用户每天一条记录，数据量会急剧膨胀（亿级/年），存储成本高，统计查询效率低。

## T (Task - 任务):

以极高的空间效率实现用户每日签到，并能快速统计当月连续签到天数。

## A (Action - 行动):

1. 选择数据结构： 使用 Redis 的 BitMap（位图），它底层是 String 类型，但可以按“位”进行操作。
2. Key 的设计： 以用户 ID 和年月作为 Key，例如 sign:{userId}:{yyyyMM}。这样一个 Key 就代表一个用户一个月的签到记录。
3. 签到操作： 当用户在某天签到时，获取当天是当月的第几天（例如 15 号）。然后使用 SETBIT 命令，将对应 Key 的指定偏移量（offset = 日期 - 1，即第 14 位）的二进制位置为 1。
4. 统计连续签到：

   - 使用 BITFIELD 命令一次性获取从月初到今天为止的所有签到数据。例如 BITFIELD key GET u{dayOfMonth} 0，这将返回一个十进制数。
   - 在代码中，对这个十进制数进行位运算。通过一个循环，不断地将其与 1 进行“与”运算（num & 1）来判断最低位是否为 1。
   - 如果是 1，则连续签到天数加一，然后将数字无符号右移一位（num >>>= 1），继续判断下一天（前一天）。
   - 如果遇到 0，则表示连续签到中断，循环结束。

## R (Result - 结果):

实现了极其节省空间的签到系统。每个用户每月的签到记录仅占用约 4 个字节（31 天/8 ≈ 4 Bytes）。签到和统计操作都是基于 Redis 内存和位运算，性能极高。
