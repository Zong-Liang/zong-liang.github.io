---
title: 消息队列
date: 2024-03-07 06:00:00 +0800
categories: [Java Backend, MQ]
tags: [MQ]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: assets/img/others/wallhaven-exdl2k_2560x1440.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 什么是消息队列？

消息队列，英文全称 Message Queue，简称 MQ。从字面上看，它是一个存放消息的队列。在计算机领域，它是一种应用程序间的通信方式，允许应用程序 A 将一条信息（即消息）放入队列中，然后由应用程序 B 在稍后的某个时间点从队列中取出并进行处理。

这是一种典型的“生产者-消费者”模式。发送消息的应用程序被称为生产者（Producer），而接收和处理消息的应用程序则被称为消费者（Consumer）。消息队列本身就像一个中间件或者说是一个缓冲区，它负责临时存储这些消息，直到它们被消费。

### 1. 异步处理 (Asynchronous Processing)

这是消息队列最核心的应用之一。在很多业务场景中，一个主流程可能会包含一些非核心或者耗时较长的操作。如果采用同步调用的方式，主流程的执行必须等待这些操作全部完成，这会导致响应时间过长，用户体验下降。

**举个例子：** 在一个电商平台的下订单场景中，用户点击“下单”按钮后，后端系统需要完成一系列操作，比如：

- 创建订单记录
- 扣减库存
- 调用支付接口
- **发送下单成功短信/邮件通知**
- **增加用户积分**

在这里，发送通知和增加积分这两个操作，并不是订单创建成功的必要环节，而且可能会因为依赖外部服务（短信网关、邮件服务器）而导致耗时较长或失败。如果将这些操作同步执行，用户可能需要等待很长时间才能看到“下单成功”的提示。

引入消息队列后，主流程在创建订单和扣减库存成功后，就可以立即向用户返回成功响应。同时，它只需要将一个“订单已创建”的消息发送到消息队列中。后续的短信服务、积分服务作为消费者，会自行从队列中拉取这个消息，并执行各自的业务逻辑。这样，原本需要同步执行的耗时操作被异步化了，大大缩短了主流程的响应时间，提升了用户体验。

### 2. 应用解耦 (Decoupling)

在复杂的分布式系统中，各个服务之间往往存在着错综复杂的调用关系。如果服务 A 直接通过 RPC（远程过程调用）的方式调用服务 B，那么服务 A 就强依赖于服务 B。当服务 B 出现故障、升级或者网络抖动时，服务 A 的调用就会失败，进而可能引发整个链路的雪崩效应。

消息队列作为中间件，可以很好地解决这个问题。服务 A（生产者）不再直接调用服务 B，而是将需要传递的数据封装成消息，发送到消息队列中。服务 B（消费者）则订阅这个队列，按需消费。

通过这种方式，服务 A 和服务 B 之间不再有直接的耦合关系。服务 A 甚至不需要知道服务 B 的存在，它只需要关心消息是否成功投递到了队列。即使在服务 B 宕机或升级期间，服务 A 也可以正常地将消息发送到队列中，待服务 B 恢复后，可以继续处理积压的消息，从而保证了核心业务流程的可用性和系统的整体健壮性。

### 3. 流量削峰 (Traffic Shaping / Peak Shaving)

在高并发场景下，比如电商秒杀、大型促销活动，系统的瞬时流量可能会激增，远远超过其常规处理能力。如果任由这些请求直接冲击数据库或下游服务，很可能会因为负载过高而导致整个系统崩溃。

消息队列在这里扮演了一个“蓄水池”的角色。前端应用或服务可以以极高的速度将请求（例如，秒杀请求）写入到消息队列中。由于写入消息队列的操作通常是非常轻量和高效的，系统可以轻松应对瞬时的流量洪峰。

而后端的消费服务则可以根据自己的实际处理能力，以一个平稳的速率从队列中拉取消息进行处理。这样，就将瞬时的、不规则的流量洪峰，“削平”成了平稳的、系统可控的流量，有效地保护了后端服务和数据库，避免了系统被冲垮的风险。

### 常见的消息队列产品

业界有很多成熟的消息队列产品，比如：

- **RabbitMQ:** 基于 AMQP（高级消息队列协议）实现，具有良好的易用性和丰富的功能，支持多种消息模式。
- **Kafka:** 由 LinkedIn 开发，是一个高吞吐量、分布式的发布订阅消息系统。它被广泛应用于大数据领域，如日志收集、实时数据管道等场景，性能极高。
- **RocketMQ:** 由阿里巴巴开源，是 Java 领域的一款优秀产品，设计上参考了 Kafka，但在事务消息、顺序消息等方面做了很多优化，非常适合电商、金融等业务场景。
- **ActiveMQ:** Apache 出品的一款老牌消息队列，功能完善，支持多种协议。
