---
title: 1045. 买下所有产品的客户
date: 2024-05-19 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 排序和分组]
tags: [排序和分组]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121164619872.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1045. 买下所有产品的客户

**表结构:**

`Customer`

| Column Name | Type |
| ----------- | ---- |
| customer_id | int  |
| product_key | int  |

- 该表可能包含重复的行。
- `customer_id` 不为 NULL。
- `product_key` 是 `Product` 表的外键(reference 列)。

`Product`

| Column Name | Type |
| ----------- | ---- |
| product_key | int  |

- `product_key` 是这张表的主键（具有唯一值的列）。

**问题描述:**

编写解决方案，报告 `Customer` 表中购买了 `Product` 表中所有产品的客户的 `id`。

返回结果表 **无顺序要求**。


**示例 1:**

**输入:**
`Customer` 表:

| customer_id | product_key |
| ----------- | ----------- |
| 1           | 5           |
| 2           | 6           |
| 3           | 6           |
| 1           | 6           |

`Product` 表:

| product_key |
| ----------- |
| 5           |
| 6           |

**输出:**

| customer_id |
| ----------- |
| 1           |
| 3           |

**解释:**
购买了所有产品 (5 和 6) 的客户的 id 是 1 和 3。


## 题解

这个问题的核心是找出那些购买的 **不重复** 产品数量等于 `Product` 表中产品总数的客户。

```sql
SELECT c.customer_id
FROM Customer c
GROUP BY c.customer_id
HAVING COUNT(DISTINCT c.product_key) = (SELECT COUNT(product_key) FROM Product);
```

**查询逻辑分解:**

1. **`SELECT c.customer_id`**: 我们的目标是找出客户的 ID。
2. **`FROM Customer c`**: 我们从 `Customer` 购买记录表中获取数据。
3. **`GROUP BY c.customer_id`**: 我们按 `customer_id` 对购买记录进行分组，这样我们就可以对每个客户的购买行为进行统计。
4. **`HAVING COUNT(DISTINCT c.product_key) = ...`**: 这是筛选的核心。`HAVING` 子句用于在 `GROUP BY` 分组后对结果进行过滤。
   - `COUNT(DISTINCT c.product_key)`: 对于每个客户分组，我们计算他们购买的 **不同** 产品的数量。`DISTINCT`
     是必须的，以防止一个客户多次购买同一产品而被重复计数。
   - `(SELECT COUNT(product_key) FROM Product)`: 这是一个子查询，它计算出 `Product` 表中所有产品的总数。
   - 只有当一个客户购买的不同产品数量 **等于** 产品总数时，该客户才会被选中。
