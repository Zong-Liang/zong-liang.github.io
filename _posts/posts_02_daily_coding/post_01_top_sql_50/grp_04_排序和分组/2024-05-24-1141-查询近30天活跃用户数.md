---
title: 1141. 查询近30天活跃用户数
date: 2024-05-24 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 排序和分组]
tags: [排序和分组]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121164801056.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1141. 查询近 30 天活跃用户数

**表:** `Activity`

| Column Name   | Type                                                               |
| ------------- | ------------------------------------------------------------------ |
| user_id       | int                                                                |
| session_id    | int                                                                |
| activity_date | date                                                               |
| activity_type | ENUM('open_session', 'end_session', 'scroll_down', 'send_message') |

- 该表没有包含重复数据。
- 该表记录社交媒体网站的用户活动。
- 注意，每个会话只属于一个用户。

**问题描述:**

编写解决方案，统计截至 `2019-07-27` (包含 2019-07-27)，近 **30 天** 的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。

以 **任意顺序** 返回结果表。

---

**示例 1:**

**输入:**
`Activity` table:

| user_id | session_id | activity_date | activity_type |
| ------- | ---------- | ------------- | ------------- |
| 1       | 1          | 2019-07-20    | open_session  |
| 1       | 1          | 2019-07-20    | scroll_down   |
| 1       | 1          | 2019-07-20    | end_session   |
| 2       | 4          | 2019-07-20    | open_session  |
| 2       | 4          | 2019-07-21    | send_message  |
| 2       | 4          | 2019-07-21    | end_session   |
| 3       | 2          | 2019-07-21    | open_session  |
| 3       | 2          | 2019-07-21    | end_session   |
| 4       | 3          | 2019-06-25    | open_session  |
| 4       | 3          | 2019-06-25    | end_session   |

**输出:**

| day        | active_users |
| ---------- | ------------ |
| 2019-07-20 | 2            |
| 2019-07-21 | 2            |

**解释:** 注意非活跃用户的记录不需要展示。


## 正确答案 (MySQL)

您需要首先筛选出指定日期范围内的活动，然后按天分组，并计算每天的不重复用户数。

```sql
SELECT activity_date AS day,
    COUNT(DISTINCT user_id) AS active_users
FROM
    Activity
WHERE
    activity_date BETWEEN DATE_SUB('2019-07-27'
    , INTERVAL 29 DAY)
  AND '2019-07-27'
GROUP BY
    activity_date;
```

**查询逻辑分解:**

1. **`WHERE activity_date BETWEEN DATE_SUB('2019-07-27', INTERVAL 29 DAY) AND '2019-07-27'`**:

   - 这是筛选条件，用于获取从 `2019-07-27` 往前推算 30 天（包含当天）的所有活动记录。
   - `DATE_SUB('2019-07-27', INTERVAL 29 DAY)` 计算出 30 天窗口的起始日期。

2. **`GROUP BY activity_date`**:

   - 按 `activity_date` 对筛选出的记录进行分组，这样我们就可以对每一天的活动进行单独统计。

3. **`SELECT activity_date AS day, COUNT(DISTINCT user_id) AS active_users`**:
   - `activity_date AS day`: 选择日期并将其重命名为 `day`。
   - `COUNT(DISTINCT user_id)`: 这是计算每日活跃用户的核心。对于每个日期分组，它会计算 **不重复的** `user_id` 的数量。
     `DISTINCT` 确保了即使一个用户在一天内有多次活动，他也只会被计算一次。
   - `AS active_users`: 将计数结果重命名为 `active_users`。

这个查询会自动忽略在指定日期范围内没有任何活动的天数，符合题目“非活跃用户的记录不需要展示”的要求。
