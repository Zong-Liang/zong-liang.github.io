---
title: 1204. 最后一个能进入巴士的人
date: 2024-06-04 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 高级查询和连接]
tags: [高级查询和连接]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121165350323.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1204. 最后一个能进入巴士的人

**表:** `Queue`

| Column Name | Type    |
| ----------- | ------- |
| person_id   | int     |
| person_name | varchar |
| weight      | int     |
| turn        | int     |

- `person_id` 是这个表具有唯一值的列。
- 该表展示了所有候车乘客的信息。
- 表中 `person_id` 和 `turn` 列将包含从 1 到 n 的所有数字，其中 n 是表中的行数。
- `turn` 决定了候车乘客上巴士的顺序，其中 `turn=1` 表示第一个上巴士，`turn=n` 表示最后一个上巴士。
- `weight` 表示候车乘客的体重，以千克为单位。

**问题描述:**

有一队乘客在等着上巴士。然而，巴士有 **1000 千克** 的重量限制，所以其中一部分乘客可能无法上巴士。

编写解决方案找出 **最后一个** 上巴士且不超過重量限制的乘客，并报告 `person_name`。题目测试用例确保顺位第一的人可以上巴士且巴士不会超重。

**示例 1:**

**输入:**

`Queue` 表:

| person_id | person_name | weight | turn |
| --------- | ----------- | ------ | ---- |
| 5         | Alice       | 250    | 1    |
| 3         | Alex        | 350    | 2    |
| 6         | John Cena   | 400    | 3    |
| 2         | Marie       | 200    | 4    |
| 1         | Winston     | 500    | 6    |
| 4         | Bob         | 175    | 5    |

**输出:**

| person_name |
| ----------- |
| John Cena   |

**解释:**

按 `turn` 排序后的上车顺序和累计重量如下：

- 1. Alice: 250 (累计: 250)
- 2. Alex: 350 (累计: 600)
- 3. John Cena: 400 (累计: 1000)
- 4. Marie: 200 (累计: 1200 - 超重)

因此，John Cena 是最后一个能上车的人。

## 题解

这个问题可以通过计算累计重量（Running Total）来解决。使用窗口函数 `SUM() OVER ()` 是最直接有效的方法。

```sql
SELECT q.person_name
FROM (SELECT person_name,
             turn,
             SUM(weight) OVER (ORDER BY turn) AS cumulative_weight
      FROM Queue) AS q
WHERE q.cumulative_weight <= 1000
ORDER BY q.turn DESC LIMIT 1;
```

**查询逻辑分解:**

1. **子查询 `(SELECT ... ) AS q`**:

   - `SUM(weight) OVER (ORDER BY turn) AS cumulative_weight`: 这是核心部分，一个窗口函数。

     - `ORDER BY turn`: 指定了计算的顺序，即按照乘客的上车顺序。
     - `SUM(weight) OVER (...)`: 对 `weight` 列进行累加。对于每一行，它会计算从第一行到当前行（按 `turn` 排序后）的所有 `weight` 的总和。

   - 这个子查询会为每一位乘客计算出当他上车时巴士的总重量。

2. **主查询 `SELECT q.person_name FROM ...`**:

   - `WHERE q.cumulative_weight <= 1000`: 从子查询的结果中，筛选出所有累计重量小于或等于 1000 的乘客。这些是所有能成功上车的人。
   - `ORDER BY q.turn DESC`: 将这些能上车的乘客按他们的上车顺序（`turn`）**降序**排列。这样，最后一个能上车的人就会排在第一位。
   - `LIMIT 1`: 选取排序后的第一行，即为最终答案。
