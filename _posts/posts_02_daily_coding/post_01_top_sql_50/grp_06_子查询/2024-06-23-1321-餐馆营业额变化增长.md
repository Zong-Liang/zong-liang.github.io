---
title: 1321. 餐馆营业额变化增长
date: 2024-06-23 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 子查询]
tags: [子查询]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121170425609.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1321. 餐馆营业额变化增长

**表:** `Customer`

| Column Name | Type    |
| ----------- | ------- |
| customer_id | int     |
| name        | varchar |
| visited_on  | date    |
| amount      | int     |

- 在 SQL 中, `(customer_id, visited_on)` 是该表的主键。
- 该表包含一家餐馆的顾客交易数据。
- `visited_on` 表示 `(customer_id)` 的顾客在 `visited_on` 那天访问了餐馆。
- `amount` 是一个顾客某一天的消费总额。

**问题描述:**

你是餐馆的老板，现在你想分析一下可能的营业额变化增长（每天至少有一位顾客）。

计算以 7 天（某日期 + 该日期前的 6 天）为一个时间段的顾客消费平均值。`average_amount` 要 **保留两位小数**。

结果按 `visited_on` **升序排序**。

**示例 1:**

**输入:**
`Customer` 表:

| customer_id | name    | visited_on | amount |
| ----------- | ------- | ---------- | ------ |
| 1           | Jhon    | 2019-01-01 | 100    |
| 2           | Daniel  | 2019-01-02 | 110    |
| 3           | Jade    | 2019-01-03 | 120    |
| 4           | Khaled  | 2019-01-04 | 130    |
| 5           | Winston | 2019-01-05 | 110    |
| 6           | Elvis   | 2019-01-06 | 140    |
| 7           | Anna    | 2019-01-07 | 150    |
| 8           | Maria   | 2019-01-08 | 80     |
| 9           | Jaze    | 2019-01-09 | 110    |
| 1           | Jhon    | 2019-01-10 | 130    |
| 3           | Jade    | 2019-01-10 | 150    |

**输出:**

| visited_on | amount | average_amount |
| ---------- | ------ | -------------- |
| 2019-01-07 | 860    | 122.86         |
| 2019-01-08 | 840    | 120.00         |
| 2019-01-09 | 840    | 120.00         |
| 2019-01-10 | 1000   | 142.86         |

**解释:**

- 第一个七天消费平均值从 2019-01-01 到 2019-01-07 是 (100 + 110 + 120 + 130 + 110 + 140 + 150)/7 = 122.86
- 第二个七天消费平均值从 2019-01-02 到 2019-01-08 是 (110 + 120 + 130 + 110 + 140 + 150 + 80)/7 = 120
- ... 以此类推

## 正确答案 (MySQL)

这个问题是计算移动平均值的典型场景，非常适合使用窗口函数来解决。

```sql
WITH DailyTotals AS (
    -- 步骤 1: 按天汇总消费总额
    SELECT visited_on,
           SUM(amount) AS daily_amount
    FROM Customer
    GROUP BY visited_on),
     MovingWindow AS (
         -- 步骤 2: 使用窗口函数计算7天的移动总和与天数
         SELECT visited_on,
                SUM(daily_amount) OVER(ORDER BY visited_on ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS amount, COUNT(visited_on) OVER(ORDER BY visited_on ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS day_count
         FROM DailyTotals)
-- 步骤 3: 筛选出完整的7天窗口，并计算平均值
SELECT visited_on,
       amount,
       ROUND(amount / 7, 2) AS average_amount
FROM MovingWindow
WHERE day_count = 7
ORDER BY visited_on;
```

**查询逻辑分解:**

1. **`WITH DailyTotals AS (...)` (步骤 1):**

   - 首先，由于同一天可能有多笔消费记录，我们需要先按 `visited_on` 分组，使用 `SUM(amount)` 计算出每天的总营业额。这个结果作为一个公共表表达式（CTE）
     `DailyTotals`。

2. **`WITH MovingWindow AS (...)` (步骤 2):**

   - 在 `DailyTotals` 的基础上，我们使用窗口函数来计算移动总和。
   - `SUM(daily_amount) OVER(ORDER BY visited_on ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS amount`:
     这会计算当前行（当天）及其前面 6 行（前 6 天）的 `daily_amount` 之和，构成一个 7 天的滑动窗口。
   - `COUNT(visited_on) OVER(...) AS day_count`: 同时，我们计算这个窗口内有多少天的数据。

3. **最终 `SELECT` (步骤 3):**
   - `WHERE day_count = 7`: 我们只对那些有完整 7 天数据的窗口感兴趣。这个条件会过滤掉数据开始的前 6 天，因为它们的窗口期不足 7 天。
   - `ROUND(amount / 7, 2) AS average_amount`: 对于筛选出的记录，我们将 7 天的总和 `amount` 除以 7，并使用 `ROUND()`
     函数四舍五入到两位小数，得到 `average_amount`。
   - `ORDER BY visited_on`: 最后按要求对结果进行排序。
