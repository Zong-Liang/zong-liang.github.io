---
title: 1193. 每月交易 I
date: 2024-05-08 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 聚合函数]
tags: [聚合函数]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121163834223.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1193. 每月交易 I

**表:** `Transactions`

| Column Name | Type                         |
| ----------- | ---------------------------- |
| id          | int                          |
| country     | varchar                      |
| state       | enum('approved', 'declined') |
| amount      | int                          |
| trans_date  | date                         |

- `id` 是这个表的主键。
- 该表包含有关传入事务的信息。
- `state` 列类型为 `["approved", "declined"]` 之一。

**问题描述:**

编写一个 sql 查询来查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。

以 **任意顺序** 返回结果表。

**示例 1:**

**输入:**
`Transactions` table:

| id  | country | state    | amount | trans_date |
| --- | ------- | -------- | ------ | ---------- |
| 121 | US      | approved | 1000   | 2018-12-18 |
| 122 | US      | declined | 2000   | 2018-12-19 |
| 123 | US      | approved | 2000   | 2019-01-01 |
| 124 | DE      | approved | 2000   | 2019-01-07 |

**输出:**

| month   | country | trans_count | approved_count | trans_total_amount | approved_total_amount |
| ------- | ------- | ----------- | -------------- | ------------------ | --------------------- |
| 2018-12 | US      | 2           | 1              | 3000               | 1000                  |
| 2019-01 | US      | 1           | 1              | 2000               | 2000                  |
| 2019-01 | DE      | 1           | 1              | 2000               | 2000                  |

## 正确答案 (MySQL)

你可以使用 `GROUP BY` 按月份和国家进行分组，并使用条件聚合（`SUM` with `CASE` 或 `IF`）来计算已批准的交易。

```sql
SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month,
    country,
    COUNT(id) AS trans_count,
    SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count,
    SUM(amount) AS trans_total_amount,
    SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_total_amount
FROM
    Transactions
GROUP BY
    DATE_FORMAT(trans_date, '%Y-%m'),
    country;
```

**查询逻辑分解:**

1. **`GROUP BY DATE_FORMAT(trans_date, '%Y-%m'), country`**:

   - `DATE_FORMAT(trans_date, '%Y-%m')`: 从 `trans_date` 列中提取年份和月份（格式如 '2019-01'），并将其作为分组键之一。
   - `country`: 将国家作为第二个分组键。
   - 这会将所有在同一个月、同一个国家发生的交易聚合到一组中。

2. **`SELECT ...` (聚合函数)**:
   - `DATE_FORMAT(...) AS month`: 选择格式化后的月份字符串，并重命名为 `month`。
   - `country`: 选择国家。
   - `COUNT(id) AS trans_count`: 计算每个分组中的总交易数量。
   - `SUM(amount) AS trans_total_amount`: 计算每个分组中的总交易金额。
   - `SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count`: 这是一个条件计数。`CASE` 语句检查 `state`
     是否为 'approved'。如果是，则计为 1，否则计为 0。`SUM` 将这些 1 和 0 相加，得到已批准的交易总数。
   - `SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_total_amount`: 这是一个条件求和。`CASE` 语句检查
     `state`。如果交易被批准，则将其 `amount` 加入总和；否则，加 0。这会计算出已批准交易的总金额。
