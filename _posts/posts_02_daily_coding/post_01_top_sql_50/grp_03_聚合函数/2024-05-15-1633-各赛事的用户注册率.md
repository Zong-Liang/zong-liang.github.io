---
title: 1633. 各赛事的的用户注册率
date: 2024-05-15 06:00:00 +0800
categories: [Daily Coding, Top SQL 50, 聚合函数]
tags: [聚合函数]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251121164308485.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 题目：1633. 各赛事的的用户注册率

**用户表:** `Users`

| Column Name | Type    |
| ----------- | ------- |
| user_id     | int     |
| user_name   | varchar |

- `user_id` 是该表的主键。
- 该表中的每行包括用户 ID 和用户名。

**注册表:** `Register`

| Column Name | Type |
| ----------- | ---- |
| contest_id  | int  |
| user_id     | int  |

- `(contest_id, user_id)` 是该表的主键。
- 该表中的每行包含用户的 ID 和他们注册的赛事。

**问题描述:**

编写解决方案统计出各赛事的的用户注册百分率，**保留两位小数**。

返回的结果表按 `percentage` 的 **降序** 排序，若相同则按 `contest_id` 的 **升序** 排序。

**示例 1:**

**输入:**
`Users` 表:

| user_id | user_name |
| ------- | --------- |
| 6       | Alice     |
| 2       | Bob       |
| 7       | Alex      |

`Register` 表:

| contest_id | user_id |
| ---------- | ------- |
| 215        | 6       |
| 209        | 2       |
| 208        | 2       |
| 210        | 6       |
| 208        | 6       |
| 209        | 7       |
| 209        | 6       |
| 215        | 7       |
| 208        | 7       |
| 210        | 2       |
| 207        | 2       |
| 210        | 7       |

**输出:**

| contest_id | percentage |
| ---------- | ---------- |
| 208        | 100.00     |
| 209        | 100.00     |
| 210        | 100.00     |
| 215        | 66.67      |
| 207        | 33.33      |

**解释:**

- 所有用户都注册了 208、209 和 210 赛事，因此这些赛事的注册率为 100%
- Alice 和 Alex 注册了 215 赛事，注册率为 ((2/3) \* 100) = 66.67%
- Bob 注册了 207 赛事，注册率为 ((1/3) \* 100) = 33.33%

## 题解

你需要计算每个赛事的注册人数，然后除以总用户数。总用户数可以通过对 `Users` 表进行计数得到。

```sql
SELECT r.contest_id,
       ROUND(
               COUNT(r.user_id) * 100.0 / (SELECT COUNT(*) FROM Users),
               2
       ) AS percentage
FROM Register r
GROUP BY r.contest_id
ORDER BY percentage DESC,
         r.contest_id ASC;
```

**查询逻辑分解:**

1. **`GROUP BY r.contest_id`**:

   - 首先，我们按 `contest_id` 对 `Register` 表进行分组，以便对每个赛事进行单独的统计。

2. **`COUNT(r.user_id)`**:

   - 对于每个赛事分组，我们计算注册的 `user_id` 数量，这就是该赛事的注册人数（分子）。

3. **`(SELECT COUNT(*) FROM Users)`**:

   - 这是一个子查询，用于计算 `Users` 表中的总行数，即总用户数（分母）。

4. **`ROUND( ... * 100.0 / ..., 2) AS percentage`**:

   - 我们将每个赛事的注册人数乘以 100.0（使用 `.0` 确保进行浮点数除法），然后除以总用户数，得到注册百分比。
   - `ROUND(..., 2)` 函数将计算出的百分比四舍五入到小数点后两位。
   - `AS percentage` 将结果列重命名。

5. **`ORDER BY percentage DESC, r.contest_id ASC`**:
   - 最后，根据题目要求对结果进行排序：首先按 `percentage` 降序排列，如果百分比相同，则按 `contest_id` 升序排列。
