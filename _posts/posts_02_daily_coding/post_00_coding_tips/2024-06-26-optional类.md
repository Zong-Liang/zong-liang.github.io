---
title: Optional类
date: 2024-06-26 06:00:00 +0800
categories: [Daily Coding, Coding Tips, Optional类]
tags: [Optional类]
toc: true
math: true
pin: false
render_with_liquid: false
image:
  path: https://cdn.jsdelivr.net/gh/Zong-Liang/blog_images/blog/2024/daily_coding/20251124105234133.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
---

## 概述

### 1. 什么是 Optional？

`Optional` 是一个容器对象，它可能包含也可能不包含非空值。如果 `Optional` 包含一个值，我们就说这个值是“存在的”；如果它不包含值，我们就说它是“空的”。

`Optional` 的主要目的是为那些可能返回 `null` 的方法提供一个明确的、类型安全的方式来表示“可能没有值”的情况，从而强制调用者处理缺失值，而不是简单地忽略 `null` 检查，最终导致 `NullPointerException`。

### 2. 为什么需要 Optional？

在传统的 Java 编程中，`null` 值是一个常见的陷阱。方法返回 `null` 常常意味着：

- 没有找到结果。
- 操作失败。
- 某个属性不存在。

调用者通常需要显式地进行 `null` 检查，否则就会在运行时抛出 `NullPointerException`。这种大量的 `null` 检查使得代码冗余、可读性差，并且容易出错（“亿万美金的错误”）。`Optional` 提供了一种更声明式、更安全的方式来处理这种不确定性。

### 3. Optional 的创建

- **`Optional.empty()`**: 创建一个空的 `Optional` 实例。
- **`Optional.of(T value)`**: 创建一个包含指定非空值的 `Optional` 实例。**如果传入 `null` 会立即抛出 `NullPointerException`。**
- **`Optional.ofNullable(T value)`**: 创建一个包含指定值的 `Optional` 实例。如果值非空，则创建一个包含值的 `Optional`；如果值为 `null`，则创建一个空的 `Optional`。这是最常用的创建方式。

### 4. Optional 的常用方法

- **`isPresent()`**: 如果 `Optional` 包含值，返回 `true`；否则返回 `false`。
- **`isEmpty()` (Java 11+)**: 如果 `Optional` 不包含值，返回 `true`；否则返回 `false`。
- **`get()`**: 如果 `Optional` 包含值，则返回该值；否则抛出 `NoSuchElementException`。**这是最不推荐使用的方法之一，因为它违背了 `Optional` 的初衷（避免 `NullPointerException`），除非你已经确定 `Optional` 肯定有值。**
- **`orElse(T other)`**: 如果 `Optional` 包含值，则返回该值；否则返回指定的默认值 `other`。
- **`orElseGet(Supplier<? extends T> other)`**: 如果 `Optional` 包含值，则返回该值；否则调用 `Supplier` 函数来生成一个默认值并返回。`orElseGet` 相比 `orElse` 的优势是，只有在 `Optional` 为空时才会执行 `Supplier` 提供的逻辑，避免了不必要的计算。
- **`orElseThrow()` / `orElseThrow(Supplier<? extends X> exceptionSupplier)`**: 如果 `Optional` 包含值，则返回该值；否则抛出 `NoSuchElementException` 或由 `Supplier` 生成的自定义异常。
- **`ifPresent(Consumer<? super T> consumer)`**: 如果 `Optional` 包含值，则对该值执行指定的 `Consumer` 操作。
- **`ifPresentOrElse(Consumer<? super T> action, Runnable emptyAction)` (Java 9+)**: 如果 `Optional` 包含值，则执行 `action`；否则执行 `emptyAction`。
- **`map(Function<? super T, ? extends R> mapper)`**: 如果 `Optional` 包含值，则对其执行 `mapper` 函数，并将结果包装在一个新的 `Optional` 中返回。如果 `Optional` 为空，则返回一个空的 `Optional`。
- **`flatMap(Function<? super T, Optional<R>> mapper)`**: 类似于 `map`，但 `mapper` 函数的返回值本身就是 `Optional`。`flatMap` 不会再次包装结果，直接返回 `mapper` 返回的 `Optional`。这在处理多层 `Optional` 嵌套时非常有用。
- **`filter(Predicate<? super T> predicate)`**: 如果 `Optional` 包含值，并且该值满足 `Predicate` 条件，则返回包含该值的 `Optional`；否则返回一个空的 `Optional`。

## Java 代码

```java
import java.util.Optional;

/**
 * @author zongliang_i
 */
public class User {
    private String name;
    private Optional<Address> address; // 使用Optional来封装可能为null的Address

    public User(String name, Optional<Address> address) {
        this.name = name;
        this.address = address;
    }

    public String getName() {
        return name;
    }

    public Optional<Address> getAddress() {
        return address;
    }

    @Override
    public String toString() {
        return "User{" +
            "name='" + name + '\'' +
            ", address=" + address.map(Address::getStreet).orElse("No Address") + // 示例中处理
            '}';
    }
}
```

```java
import java.util.Optional;

/**
 * @author zongliang_i
 */
public class Address {
    private String street;
    private Optional<String> postcode; // 邮编可能为空

    public Address(String street, Optional<String> postcode) {
        this.street = street;
        this.postcode = postcode;
    }

    public String getStreet() {
        return street;
    }

    public Optional<String> getPostcode() {
        return postcode;
    }

    @Override
    public String toString() {
        return "Address{" +
            "street='" + street + '\'' +
            ", postcode=" + postcode.orElse("N/A") +
            '}';
    }
}
```

```java
/**
 * @author zongliang_i
 */
public class Person {
    private String name;
    private int age;
    private String city;

    public Person(String name, int age, String city) {
        this.name = name;
        this.age = age;
        this.city = city;
    }

    public String getName() {
        return name;
    }

    public int getAge() {
        return age;
    }

    public String getCity() {
        return city;
    }

    @Override
    public String toString() {
        return "Person{" +
            "name='" + name + '\'' +
            ", age=" + age +
            ", city='" + city + '\'' +
            '}';
    }
}
```

```java
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

/**
 * @author zongliang_i
 */
public class Main {
    // 模拟一个可能返回null的方法
    public static String getUsernameById(Long id) {
        if (id != null && id == 1L) {
            return "Alice";
        }
        return null; // id为其他值或为null时返回null
    }

    // 模拟一个返回Optional的方法
    public static Optional<String> getOptionalUsernameById(Long id) {
        if (id != null && id == 1L) {
            return Optional.of("Alice");
        } else if (id != null && id == 2L) {
            return Optional.ofNullable(null); // 明确返回Optional.empty()
        }
        return Optional.empty(); // 其他情况返回空Optional
    }

    public static void main(String[] args) {

        System.out.println("--- 1. Optional 的创建 ---");
        // 创建一个空的Optional
        Optional<String> emptyOptional = Optional.empty();
        System.out.println("Empty Optional: " + emptyOptional);

        // 创建一个包含值的Optional (值不能为null)
        Optional<String> presentOptional = Optional.of("Hello Optional");
        System.out.println("Present Optional: " + presentOptional);

        // Optional.of(null) 会抛出 NullPointerException
        // Optional<String> nullOf = Optional.of(null); // 运行时异常！

        // 最常用的创建方式：ofNullable
        String nullableString = "I am not null";
        Optional<String> ofNullablePresent = Optional.ofNullable(nullableString);
        System.out.println("ofNullable (present): " + ofNullablePresent);

        String anotherNullString = null;
        Optional<String> ofNullableEmpty = Optional.ofNullable(anotherNullString);
        System.out.println("ofNullable (empty): " + ofNullableEmpty);


        System.out.println("\n--- 2. 避免 NullPointerException 的传统方式 vs Optional ---");

        // 传统方式：需要手动检查null
        String username = getUsernameById(1L);
        if (username != null) {
            System.out.println("Traditional username (ID 1): " + username.toUpperCase());
        } else {
            System.out.println("Traditional: Username for ID 1 not found or is null.");
        }

        String username3 = getUsernameById(3L);
        if (username3 != null) {
            System.out.println("Traditional username (ID 3): " + username3.toUpperCase());
        } else {
            System.out.println("Traditional: Username for ID 3 not found or is null.");
        }

        // 使用 Optional 方式
        Optional<String> optUsername1 = getOptionalUsernameById(1L);
        optUsername1.ifPresent(u -> System.out.println("Optional username (ID 1): " + u.toUpperCase())); // 如果存在则执行
        System.out.println("Optional username (ID 1) with default: " + optUsername1.orElse("Default User").toUpperCase());

        Optional<String> optUsername2 = getOptionalUsernameById(2L); // 这个方法专门返回Optional.empty()
        optUsername2.ifPresent(u -> System.out.println("Optional username (ID 2): " + u.toUpperCase()));
        System.out.println("Optional username (ID 2) with default: " + optUsername2.orElse("Default User").toUpperCase());

        Optional<String> optUsername3 = getOptionalUsernameById(3L);
        optUsername3.ifPresent(u -> System.out.println("Optional username (ID 3): " + u.toUpperCase()));
        System.out.println("Optional username (ID 3) with default: " + optUsername3.orElse("Default User").toUpperCase());


        System.out.println("\n--- 3. Optional 的常用方法演示 ---");

        Optional<String> valuePresent = Optional.of("Hello Java");
        Optional<String> valueEmpty = Optional.empty();

        // isPresent() / isEmpty() (Java 11+)
        System.out.println("valuePresent is present? " + valuePresent.isPresent()); // true
        System.out.println("valueEmpty is present? " + valueEmpty.isPresent());   // false
        System.out.println("valuePresent is empty? " + valuePresent.isEmpty());   // false
        System.out.println("valueEmpty is empty? " + valueEmpty.isEmpty());     // true

        // get() - 慎用，如果为空会抛异常
        // System.out.println("valueEmpty.get(): " + valueEmpty.get()); // throws NoSuchElementException

        // orElse() - 如果为空提供默认值
        String result1 = valuePresent.orElse("Default Value");
        System.out.println("orElse (present): " + result1); // Hello Java
        String result2 = valueEmpty.orElse("Default Value");
        System.out.println("orElse (empty): " + result2);   // Default Value

        // orElseGet() - 懒加载默认值，只有在Optional为空时才执行Supplier
        System.out.println("\norElseGet demonstration:");
        String result3 = valuePresent.orElseGet(() -> {
            System.out.println("This supplier is NOT executed for present Optional.");
            return "Generated Default";
        });
        System.out.println("orElseGet (present): " + result3);

        String result4 = valueEmpty.orElseGet(() -> {
            System.out.println("This supplier IS executed for empty Optional.");
            return "Generated Default";
        });
        System.out.println("orElseGet (empty): " + result4);

        // orElseThrow() - 如果为空抛出异常
        try {
            String result5 = valueEmpty.orElseThrow(() -> new IllegalArgumentException("Value was missing!"));
            System.out.println("orElseThrow (empty) - This won't be printed.");
        } catch (IllegalArgumentException e) {
            System.out.println("Caught expected exception: " + e.getMessage());
        }

        // ifPresent() - 如果存在则执行Consumer
        System.out.println("\nifPresent demonstration:");
        valuePresent.ifPresent(val -> System.out.println("Value is: " + val)); // Value is: Hello Java
        valueEmpty.ifPresent(val -> System.out.println("Value is: " + val));   // 不打印任何东西

        // ifPresentOrElse() (Java 9+)
        System.out.println("\nifPresentOrElse demonstration (Java 9+ feature):");
        valuePresent.ifPresentOrElse(
            val -> System.out.println("Value present: " + val),
            () -> System.out.println("Value not present.")
        );
        valueEmpty.ifPresentOrElse(
            val -> System.out.println("Value present: " + val),
            () -> System.out.println("Value not present.")
        );


        System.out.println("\n--- 4. Optional 结合 map() 和 flatMap() ---");

        // 场景：获取用户的街道信息，可能用户、地址、邮编都为空
        User userWithAddress = new User("John Doe",
            Optional.of(new Address("123 Main St", Optional.of("10001"))));
        User userWithoutAddress = new User("Jane Doe", Optional.empty());
        User userWithAddressNoPostcode = new User("Peter Pan",
            Optional.of(new Address("456 Elm St", Optional.empty())));

        // 使用 map 获取街道信息
        Optional<String> street1 = userWithAddress.getAddress().map(Address::getStreet);
        street1.ifPresent(s -> System.out.println("User John Doe lives on: " + s)); // 123 Main St

        Optional<String> street2 = userWithoutAddress.getAddress().map(Address::getStreet);
        System.out.println("User Jane Doe lives on: " + street2.orElse("Unknown Street")); // Unknown Street

        // 获取邮编信息，这里涉及到Optional的嵌套
        // 错误的示例：map会返回 Optional<Optional<String>>
        Optional<Optional<String>> postcodeNested = userWithAddress.getAddress().map(Address::getPostcode);
        postcodeNested.ifPresent(opt -> opt.ifPresent(p -> System.out.println("Nested postcode: " + p)));

        // 正确的示例：使用 flatMap 扁平化Optional
        Optional<String> postcodeFlat1 = userWithAddress.getAddress()
            .flatMap(Address::getPostcode); // Address::getPostcode 返回 Optional<String>
        postcodeFlat1.ifPresent(p -> System.out.println("Flat postcode (John Doe): " + p)); // 10001

        Optional<String> postcodeFlat2 = userWithoutAddress.getAddress()
            .flatMap(Address::getPostcode);
        System.out.println("Flat postcode (Jane Doe): " + postcodeFlat2.orElse("No Postcode")); // No Postcode

        Optional<String> postcodeFlat3 = userWithAddressNoPostcode.getAddress()
            .flatMap(Address::getPostcode);
        System.out.println("Flat postcode (Peter Pan): " + postcodeFlat3.orElse("No Postcode")); // No Postcode

        System.out.println("\n--- 5. Optional 的 filter() ---");
        // 筛选出包含"Java"的Optional值
        Optional<String> filteredPresent = Optional.of("Hello Java World")
            .filter(s -> s.contains("Java"));
        filteredPresent.ifPresent(s -> System.out.println("Filtered present: " + s)); // Hello Java World

        Optional<String> filteredEmpty = Optional.of("Hello C++ World")
            .filter(s -> s.contains("Java"));
        System.out.println("Filtered empty: " + filteredEmpty.orElse("No Java in string")); // No Java in string

        List<Person> people = Arrays.asList(
            new Person("Alice", 30, "New York"),
            new Person("Bob", 25, "London"),
            new Person("Charlie", 35, "New York"),
            new Person("David", 25, "Paris"),
            new Person("Eve", 40, "London"),
            new Person("Frank", 30, "New York")
        );

        // 结合map和filter
        people.stream()
            .filter(p -> p.getCity().equals("New York")) // 筛选出纽约的人
            .map(Person::getName) // 映射出名字
            .filter(name -> name.startsWith("A")) // 筛选名字以A开头的
            .findFirst() // 找到第一个
            .ifPresent(name -> System.out.println("First NY person with name starting with 'A': " + name));

    }
}
```
