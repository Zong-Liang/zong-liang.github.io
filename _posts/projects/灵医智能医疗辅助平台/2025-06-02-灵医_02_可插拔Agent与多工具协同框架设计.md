---
title: "灵医_02_可插拔Agent与多工具协同框架设计"
date: 2025-06-02 01:01:01 +0800
categories: [JAVA后端项目, 灵医智能医疗辅助平台]
tags: [RAG, Agent, Spring AI]
pin: false
toc: true
math: true
---

## 相关概念:

### Spring AI 函数调用 (Function Calling):

函数调用是现代大型语言模型（如 OpenAI 的 GPT 系列）的一项核心能力。它允许开发者在与模型交互时，定义一系列可供模型调用的外部函数或工具。当用户的提问需要这些工具来完成时，模型不会直接编造答案，而是会生成一个包含函数名和所需参数的 JSON 对象。开发者可以捕获这个 JSON 对象，执行相应的本地代码（即调用工具），然后将执行结果返回给模型，让模型根据这个结果生成最终的、基于真实数据的答案。

### Spring Bean 与 @Description 注解:

- Spring Bean: 在 Spring 框架中，Bean 是由 Spring IoC（Inversion of Control）容器管理的对象。 它们是构成应用程序主干的基本构建块。将业务逻辑（如“药品信息查询”）封装为 Spring Bean，可以利用 Spring 框架的依赖注入、生命周期管理等功能。
- @Description 注解: Spring AI 巧妙地利用了这一点。通过在一个 Spring Bean 的方法上添加@Description 注解，并用自然语言清晰地描述该方法的功能、参数和用途，Spring AI 能够自动将这个 Bean 方法转换并注册为可供 LLM 调用的“工具”。 这种方式实现了业务功能到 AI 工具的“无感转换”，开发者无需编写复杂的适配代码，只需关注业务逻辑本身，并为其提供清晰的描述即可。

### 语义路由 (Semantic Routing):

- 语义路由是一种智能决策机制，它通常位于系统的流量入口层。当一个用户请求进入系统时，语义路由器会利用大型语言模型（LLM）来分析和理解请求的“意图”（Intent）。 根据分析结果，路由器会决定这个请求应该被分发到哪个下游处理单元。在本项目中，LLM 会判断：

  - 这是一个知识问答类问题吗？如果是，则将请求路由到 RAG（检索增强生成）流程，通过知识库来回答。
  - 这是一个需要执行具体操作的任务吗？例如“帮我查询一下阿司匹林这个药”，如果是，则将请求路由到 Agent 服务层，调用相应的外部工具（如药品信息查询 API）。
  - 这是一个复合型任务吗？例如“根据我的过敏史，查一下阿司匹林我能吃吗？”这可能需要先调用“用户档案检索”工具，再调用“药品信息查询”工具，最后进行综合判断。

通过这种方式，系统能够动态地选择最优路径来处理用户请求，而不是使用固定的、单一的处理流程，从而能够应对更广泛和复杂的任务场景。

### 开发与集成成本的降低:

该框架的最大优势在于其“可插拔性”和自动化。传统的工具集成可能需要编写大量的 API 调用、数据转换和错误处理代码。而在这个框架下，新增一个业务工具的流程被大大简化：

1. 将业务逻辑开发成一个标准的 Java 方法。
2. 将其封装在一个 Spring Bean 中。
3. 为该方法添加一个清晰的@Description 注解。

Spring AI 框架会自动处理剩下的所有事情，包括将其注册给 LLM、处理调用请求和参数解析。这使得**将一个新的业务能力集成到 AI 系统中的成本从原本可能的数天时间，降低到了小时级别**。成功接入“信息检索”、“用户档案查询”和“资源预约系统”等核心工具，证明了该框架的高效性和可扩展性。

## 知识点:

### Agent 与 函数调用 (Function Calling)

1. 是什么： Agent 是一个具备“思考-行动”循环能力的智能体。它不仅能回答问题，还能自主决定调用外部工具（API、数据库查询等）来完成任务。函数调用是 LLM（如 GPT-4）提供的一项核心能力，它能根据你的描述，将用户的自然语言指令，转换为结构化的函数调用请求（一个包含函数名和参数的 JSON 对象）。

2. 为什么用：打破 LLM 的“数字囚笼”，让它能与真实世界的系统交互。在“灵医”中，用户不仅可以问医学知识（RAG 处理），还可以说“帮我查一下张医生的排班”（Agent 调用排班工具）、“把这份病历摘要发给李主任”（Agent 调用消息发送工具）。

3. 面试深挖：

   - Q: "请描述一下一个完整的函数调用流程是怎样的？"
     - A: 1. 定义： 在代码中（如 Java Bean）定义好工具函数，并用清晰的自然语言（如@Description 注解）描述它的功能、参数、返回值。2. 请求： 将用户的 Query 和工具定义列表一起发给 LLM。3. 思考： LLM 分析 Query，如果认为需要使用工具，它不会直接回答，而是返回一个特定结构的 JSON，要求我们去调用某个函数并提供所需参数。4. 执行： 我们的后端代码解析这个 JSON，执行对应的本地 Java 方法。5. 响应： 将 Java 方法的执行结果再发回给 LLM。6. 综合： LLM 拿到工具的执行结果后，会用自然语言组织一段最终的答复返回给用户。

### Spring AI 的 Agent 实现 (@Bean + @Description)

1. 是什么：Spring AI 的优雅之处在于，它将函数调用与 Spring 框架无缝集成。你不需要手动拼装复杂的 JSON Schema 给 LLM。只需将你的工具方法声明为一个标准的 Spring Bean，并用@Description 注解来描述它，Spring AI 会自动在后台完成所有繁琐的转换工作。

2. 为什么用：极大地降低了开发门槛，提高了开发效率。Java 开发者可以用最熟悉的方式（写 Service、写 Bean）来扩展 AI 的能力，而无需深入学习 LLM 函数调用的底层细节。这使得“万物皆可为工具”，任何一个 Spring 应用中的服务，都可以轻松被 AI 赋能和调用。

3. 面试深挖：

   - Q: "如果一个工具方法需要复杂的输入参数（比如一个包含多个字段的 DTO 对象），Spring AI 能支持吗？"
     - A: 完全支持。你可以在 Function 的泛型中直接使用你的 DTO 类。Spring AI 会自动解析这个 DTO 的结构（字段名、类型），并生成对应的 JSON Schema。LLM 会“理解”这个结构，并在需要时返回一个填充好所有字段的 JSON 对象，Spring AI 会为你自动反序列化成这个 DTO 的实例，你在 Java 代码里直接使用即可，非常方便。。

### 语义路由 (Semantic Routing)

1. 是什么：在处理用户请求的一开始，先用一个专门的 LLM 调用来做“分流决策”。这个 LLM 的角色像个总机，它不负责具体执行，只负责判断这个请求应该“转接”给谁处理——是走 RAG 知识问答，还是调用预约工具，还是调用用户信息查询工具。

2. 为什么用：

   - 提升准确性： 避免给最终的执行 Agent 提供过多无关工具，这会干扰它的判断。让专人干专事。
   - 降低成本： 路由判断通常可以用更小、更快的模型来完成，只有确定了具体任务后，才调用更强大（也更贵）的模型去执行。
   - 增强可观测性： 清晰地知道每个请求被路由到了哪个流程，便于调试和分析。

3. 面试深挖：

   - Q: "如果用户的指令很复杂，比如‘根据最新的糖尿病指南，帮我预约一位擅长此领域的内分泌专家’，你的语义路由会怎么处理？"
     - A: 这是一个很好的复合意图问题。我的路由设计会支持返回一个“执行链”或“任务列表”，而不是单一的决策。对于这个 Query，路由 LLM 可能会返回一个包含两个步骤的计划：[{"tool": "rag_query", "params": {"query": "最新糖尿病指南"}}, {"tool": "find_and_book_expert", "params": {"specialty": "内分泌学", "disease": "糖尿病"}}]。然后，一个执行控制器（Orchestrator）会依次调用这两个工具，并将第一步的结果（指南内容）作为参考信息提供给第二步。
